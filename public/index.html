<!DOCTYPE html>
<html>

<head>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js">
  </script>
  <link rel="manifest" href="ico/manifest.json">
  <link rel="stylesheet" type="text/css" href="bootstrap.css">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">


  <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
  <meta charset="utf-8">
  <title>Crowd Food</title>
  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    #panel {
      margin-left: 20px;
      background-color: #f7f7f7;
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      width: 50%;
    }

    #map {
      background: white;
      position: absolute;
      top: 0;
      left: 50%;
      right: 0;
      bottom: 0;
    }

    .sidebar {
      position: fixed;
      top: 5px;
      left: 0;
      bottom: 0;
      width: 50%;
      overflow-y: scroll;
      -webkit-overflow-scrolling: touch;
      background: #f7f7f7
    }
  </style>
</head>

<body>
  <div id="panel"></div>

  <div id="map"></div>
  <script>
    var infowindow = null;

    var map;

    var defaultLat = 0;
    var defaultLng = 0;
    var APIEndpoint = 'http://crowdfood.mybluemix.net/api';

    var res_json;
    var gmarkers = [];

    function CenterControl(controlDiv, map) {

      // Set CSS for the control border.
      var controlUI = document.createElement('div');
      controlUI.style.backgroundColor = '#fff';
      controlUI.style.border = '2px solid #fff';
      controlUI.style.borderRadius = '3px';
      controlUI.style.boxShadow = '0 2px 6px rgba(0,0,0,.3)';
      controlUI.style.cursor = 'pointer';
      controlUI.style.marginBottom = '22px';
      controlUI.style.textAlign = 'center';
      controlUI.title = 'Click to recenter the map';
      controlDiv.appendChild(controlUI);

      // Set CSS for the control interior.
      var controlText = document.createElement('div');
      controlText.style.color = 'rgb(25,25,25)';
      controlText.style.fontFamily = 'Roboto,Arial,sans-serif';
      controlText.style.fontSize = '16px';
      controlText.style.lineHeight = '38px';
      controlText.style.paddingLeft = '5px';
      controlText.style.paddingRight = '5px';
      controlText.innerHTML = 'My location';
      controlUI.appendChild(controlText);

      // Setup the click event listeners: simply set the map to Chicago.
      controlUI.addEventListener('click', function() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(getPosition);
        }
      });
    }

    function getPosition(position) {
      defaultLat = position.coords.latitude;
      defaultLng = position.coords.longitude;
      map.setCenter({
        lat: defaultLat,
        lng: defaultLng
      });
    }

    function initMap() {
      $.ajax({
        url: APIEndpoint + '/restaurants/short',
        crossDomain: true,
        type: 'GET',
        dataType: 'json',
        success: function(data) {
          console.log('data got\t', data);
          if (data.status == 200) {
            res_json = data.data;

            if (res_json.length >= 1) {
              defaultLat = res_json[0].attribute.loc.coordinates[0];
              defaultLng = res_json[0].attribute.loc.coordinates[1];
            } else {
              defaultLat = 35.31063;
              defaultLng = -80.749609;
            }

            map = new google.maps.Map(document.getElementById('map'), {
              zoom: 16,
              center: {
                lat: defaultLat,
                lng: defaultLng
              }
            });


            infowindow = new google.maps.InfoWindow({
              content: "loading...",
              maxWidth: 800
            });

            setMarkers(map);

            insertImgs2Div(res_json);

            var centerControlDiv = document.createElement('div');
            var centerControl = new CenterControl(centerControlDiv, map);

            centerControlDiv.index = 1;
            map.controls[google.maps.ControlPosition.TOP_CENTER].push(centerControlDiv);

          }

        },
        error: function() {
          console.log('data got failed!');
        }
      });

    }

    function myclick(i) {
      //google.maps.event.trigger(gmarkers[i], "click", updateMarkers(map, res_json[i]._id));
      updateMarkers( res_json[i]._id )
    }

    function insertImgs2Div(json) {
      var panel_html = '<div class="sidebar">'; //'<div class="col-xs-8" id="left">';
      var i;
      var div_start = '<div class="col-sm-12 row-space-1 col-md-6">';
      var div_end = '</div>';
      for (i = 0; i < json.length; i++) {
        var res = json[i];
        panel_html += div_start + '<h4 align="left" >' +
          '<a href="javascript:myclick(' + i.toString() + ')">' +
          res.attribute.name + '</a>' +
          '</h4>' +
          '<div id="bodyContent">' +
          ' <p> <img src="img/im' + (i + 1).toString() + '.jpg " height="200" width="300"> ' + div_end +
          div_end;
      }
      panel_html += '</div>';
      panel_html += '</div>';
      document.getElementById("panel").innerHTML = panel_html;
    }


    function setMarkers(map) {
      // Adds markers to the map.

      for (var i = 0; i < res_json.length; i++) {
        var res = res_json[i];
        var marker = new google.maps.Marker({
          position: {
            lat: res.attribute.loc.coordinates[0],
            lng: res.attribute.loc.coordinates[1]
          },
          map: map,
          //icon: 'http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld='+
          //(i+1).toString()  +'A|FF0000|000000',
          //icon: 'https://raw.githubusercontent.com/Concept211/Google-Maps-Markers/master/images/marker_green' + (i % 100 + 1).toString() + '.png',
          //shape: shape,
          //label: (i+1).toString(),
          title: res.attribute.name,
          //zIndex: res[3],
          html: '<h2 align="center" >' + ' ' + res.attribute.name + '</h2>' +
            '<div id="bodyContent">' +
            ' <p> <img src="img/im' + (i + 1).toString() + '.jpg " > ' +
            '<h3>Waiting Time: ' + res.attribute.waiting.toString() + ' minutes </h3> </p>' +
            '</div>'
        });

        gmarkers.push(marker);

        google.maps.event.addListener(marker, "click", function() {
          infowindow.setContent(this.html);
          infowindow.open(map, this);
        });

        google.maps.event.addListener(marker, 'mouseover', function() {
          infowindow.setContent(this.html);
          infowindow.open(map, this);
        });

        google.maps.event.addListener(marker, 'mouseout', function() {
          infowindow.close();
        });

      }
    }

    function updateMarkers(resID) {
      // Adds markers to the map.

      for (var i = 0; i < res_json.length; i++) {
        var res = res_json[i];
        if (res._id == resID) {

          $.ajax({
            url: APIEndpoint + '/restaurants/' + resID,
            crossDomain: true,
            type: 'GET',
            dataType: 'json',
            success: function(ret_json) {
              console.log('report got\t', ret_json);
              console.log('ret_json.data\t', ret_json.data);
              var reportList = ret_json.data.attribute.reports;
              var reportLen = reportList.length;
              console.log('reportLen\t', reportLen);
              if (reportLen > 0) {
                var latest_wait_time = reportList[reportLen-1].waiting;
                console.log('latest_wait_time\t', latest_wait_time);
                var latest_photo_url = '';
                for (var j = reportLen - 1; j >= 0; j--) {
                  if (reportList[j].photoUrl) {
                    latest_photo_url = reportList[j].photoUrl;
                    break;
                  }
                }
                if (latest_photo_url) {

                } else {
                  latest_photo_url = 'img/im' + (i + 1).toString() + '.jpg';
                }

                console.log('latest_photo_url\t', latest_photo_url);

                var marker = new google.maps.Marker({
                  position: {
                    lat: res.attribute.loc.coordinates[0],
                    lng: res.attribute.loc.coordinates[1]
                  },
                  map: map,
                  //icon: 'http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld='+
                  //(i+1).toString()  +'A|FF0000|000000',
                  //icon: 'https://raw.githubusercontent.com/Concept211/Google-Maps-Markers/master/images/marker_green' + (i % 100 + 1).toString() + '.png',
                  //shape: shape,
                  //label: (i+1).toString(),
                  title: res.attribute.name,
                  //zIndex: res[3],
                  html: '<h2 align="center" >' + ' ' + res.attribute.name + '</h2>' +
                    '<div id="bodyContent">' +
                    ' <p> <img src="' + latest_photo_url + '" height="500" width="600"> ' +
                    '<h3>Waiting Time: ' + latest_wait_time.toString() + ' minutes </h3> </p>' +
                    '</div>'
                });

                //gmarkers.push(marker);

                google.maps.event.addListener(marker, "click", function() {
                  infowindow.setContent(this.html);
                  infowindow.open(map, this);
                });

                google.maps.event.addListener(marker, 'mouseover', function() {
                  infowindow.setContent(this.html);
                  infowindow.open(map, this);
                });

                google.maps.event.addListener(marker, 'mouseout', function() {
                  infowindow.close();
                });


              }

              google.maps.event.trigger(marker, "click");


            },
            error: function() {
              console.log('data got failed!');
            }
          });


        }
      }
    }
  </script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?v=3.exp&callback=initMap"></script>
</body>

</html>
